<!DOCTYPE html>
<html lang="zh">
<head>
    <title>Bootstrap布局</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <link href="./css/bootstrap/4.1.0/bootstrap.css" rel="stylesheet" />
    <link href="./css/mars-doc.css" rel="stylesheet" />
    <link href="./css/ace.css">

    <script type="text/javascript" src="./js/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap/4.1.0/bootstrap.js"></script>
    <script type="text/javascript" src="./js/mars-doc.js"></script>

    <script type="text/javascript" src="./js/template-web.js"></script>
    <script type="text/javascript" src="./js/json5.js"></script>

    <script type="text/javascript" src="./js/ase/ace.js"></script>
    <script type="text/javascript" src="./js/ase/ext-language_tools.js"></script>

</head>
<body>
<div class="wrap">

    <!--顶部-->
    <div class="top">
        <div class="top-left">
            欢迎使用 mars doc
        </div>
        <div class="top-right">
            <input type="input" class="search-input form-control" name="s" placeholder="搜索..." aria-label="Search">
        </div>
    </div>

    <!-- 左边内容 -->
    <div id="left" class="left" >

        <ul id="menu" class="nav nav-list">
<!--            <li class="detailMenu">-->
<!--                <a class="ma1">一级菜单</a>-->
<!--                <ul class="submenu">-->
<!--                    <li class="menuLi">-->
<!--                        <a class="ma2">二级菜单1</a>-->
<!--                    </li>-->
<!--                    <li class="menuLi">-->
<!--                        <a class="ma2">二级菜单2</a>-->
<!--                    </li>-->
<!--                </ul>-->
<!--            </li>-->
<!--            <li class="detailMenu">-->
<!--                <a class="ma1">二级菜单</a>-->
<!--                <ul class="submenu">-->
<!--                    <li class="menuLi">-->
<!--                        <a class="ma2">二级菜单1</a>-->
<!--                    </li>-->
<!--                    <li class="menuLi">-->
<!--                        <a class="ma2">二级菜单2</a>-->
<!--                    </li>-->
<!--                </ul>-->
<!--            </li>-->
        </ul>

    </div>
    <!-- 右边内容 -->
    <div id="right" class="tab-content right">
        <ul class="nav nav-tabs right-nav">
<!--            <li class="active" ><a href="#tab1">第一个TAB</a> <span class="close"></span></li>-->
<!--            <li><a href="#tab2" >第二个TAB</a> <span class="close"></span></li>-->
        </ul>


        <div class="right-content"  id="rightContent"  style="width: 100%;height: 100%;border: 1px solid red;">

        </div>

    </div>
</div>


<div id="docTemplateId" style="display: none;">
    <div class='right-content-item active' id="{{methodUId}}">
        <div>接口&nbsp;&nbsp;&nbsp;&nbsp;名：{{method.description}}</div>
        <div>接口地址：{{method.path}}</div>
        <div>请求方式：{{method.method}}</div>
        <div>请求参数：
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>参数名称</th>
                        <th>参数说明</th>
                        <th>请求类型</th>
                        <th>是否必须</th>
                        <th>数据类型</th>
                        <th>示例值</th>
                    </tr>
                </thead>
                <tbody  id="{{ method.methodUId }}requestBodyHtml">


                </tbody>
            </table>
        </div>
        <div>响应参数：
            <table class="table table-bordered table-sm">
                <thead>
                <tr>
                    <th>参数名称</th>
                    <th>参数说明</th>
                    <th>数据类型</th>
                </tr>
                </thead>
                <tbody id="{{ method.methodUId }}responseBodyHtml">

                </tbody>
            </table>
        </div>



        {{include 'debugTemplate' }}

    </div>



</div>

<!--{{@requestBodyHtml }}-->

<script type="text/html" id="docTemplateRequest">
    {{set requestList = request.list}}
    {{each requestList as r i}}
    <tr>
        <td>{{r.name}}</td>
        <td>{{r.description}}</td>
        <td>{{r.requestType}}</td>
        <td>{{r.required}}</td>
        <td>{{r.dataType}}</td>
        <td>{{r.example}}</td>
    </tr>
    {{/each}}
</script>

<div id="docTemplateRequest2" style="display: none">
    {{each request.list as r i}}
    <tr>
        <td>{{r.name}}</td>
        <td>{{r.name}}</td>
        <td>{{r.name}}</td>
        <td>{{r.name}}</td>
        <td>{{r.name}}</td>
        <td>{{r.name}}</td>
    </tr>
    {{/each}}
</div>


<!--{{if r.child}}-->
<!--{{include 'docTemplateRequest' request }}-->
<!--{{/if}}-->
<div id="debugTemplate" style="display: none">
    <div style="width: 100%;height: 30px;">

    </div>
    <div class="input-group mb-3">
        <div class="input-group-prepend">
            <button class="btn btn-default btn-info" type="button">{{method.method}}</button>
        </div>
        <input type="text" class="form-control" value="{{method.path}}"  id="requestUrl" name="requestUrl">
        <div class="input-group-prepend">
            <button class="btn btn-secondary" type="button">发送</button>
        </div>
    </div>
    <div class="custom-control custom-radio custom-control-inline">
        <input type="radio" class="custom-control-input"  id="customRadio1{{method.methodUId}}" name="{{method.methodUId}}contentType" value="1">
        <label class="custom-control-label" for="customRadio1{{method.methodUId}}">x-www-form-urlencoded</label>
    </div>
    <div class="custom-control custom-radio custom-control-inline">
        <input type="radio" class="custom-control-input" id="customRadio2{{method.methodUId}}" name="{{method.methodUId}}contentType" value="2">
        <label class="custom-control-label" for="customRadio2{{method.methodUId}}">form-data</label>
    </div>
    <div class="custom-control custom-radio custom-control-inline">
        <input type="radio" class="custom-control-input" id="customRadio3{{method.methodUId}}" name="{{method.methodUId}}contentType" value="3">
        <label class="custom-control-label" for="customRadio3{{method.methodUId}}">raw</label>
    </div>

    <select class="form-select form-select-sm" id="{{method.methodUId}}Raw" style="display: none;" >
        <option selected>JSON(application/json)</option>
        <option>Text</option>
        <option >Text(text/plain)</option>
        <option >XML(application/xml)</option>
        <option >XML(text/xml)</option>
        <option>HTML(text/html)</option>
        <option>Javascript(application/javascript)</option>
    </select>


    <table class="table table-bordered table-sm">
        <thead class="thead-light">
        <tr>
            <th style="width: 5%;"><input type="checkbox"  checked='checked'  id="{{method.methodUId}}AllId" />全选</th>
            <th style="width: 10%;">参数类型</th>
            <th style="width: 25%;">参数名称</th>
            <th>参数值</th>
        </tr>
        </thead>
        <tbody id="{{ method.methodUId }}RequestId">

        </tbody>
    </table>

    <div>
        <ul class="nav  right-response-nav">
            <li class="active">响应内容</li>
            <li>Raw</li>
        </ul>
        <div class="right-response-content">
            <div class="ace_editor" id="{{ method.methodUId }}ace_editor" style="height: 300px;">
{
    "code": 0,//测试哦
    "data": {
    "pastExamPaperId": "",
    "testTime": 0,
    "title": "",
    "totalCount": 0
    },
    "msg": ""
}
            </div>
        </div>
    </div>

</div>

<!--<td>{{ $value.name}}</td>
                   <td>{{ $value.requestType}}</td>
                   <td>{{ $value.description}}</td>-->
</body>
<script>

    // import {template} from "./js/template-web";

    $(function () {
        init();
    });

    function initLeftMenu(){
        $("#menu .ma1").on("click",function () {
            if ($(this).parent().hasClass("active")){
                $(this).parent().removeClass("active").find(".submenu").hide();
            }else{
                $(".detailMenu").removeClass("active").find(".submenu").hide();
                $(this).parent().addClass("active").find(".submenu").show(100);
            }
        });

        $("#menu .menuLi .ma2").on("click",function (){
            addTab(this);
        });
        initTabs();
    }


    function initTabs(){
        $(".right-nav li").on("click",function (){
            $(".right-nav li").removeClass("active");
            $(this).addClass("active");
            let methodUId = $(this).find("a").attr("data-method-uid");
            rightContentItemChange(methodUId);
        });
        initTabsClose();
    }
    function initTabsClose(){
        $(".right-nav .close").on("click",function (){
            closeTab(this);
        })
    }
    function closeTab(obj){
        $(obj).parent().remove();
    }


    $(".search-input").keypress(function (even) {
        if (even.which == 13) {
            let searchInput = $(".search-input").val();

            let classList = storage.get("classList");
            if (classList){
                initLeft(JSON.parse(classList),searchInput);
            }
        }
    });



    function addTab(obj){
        let classUId = $(obj).attr("data-class-uid");
        let methodUId = $(obj).attr("data-method-uid");
        let methodId = $(obj).attr("data-method-id");

        let classList =JSON.parse(storage.get("classList"));
        let classVo = null;

        for (let k = 0; k < classList.length; k++) {
            let clazz = classList[k];
            if (clazz.classUId == classUId){
                classVo = clazz;
                break
            }
        }

        if (classVo){
            for (let j = 0; j < classVo.methodList.length; j++) {
                let method = classVo.methodList[j];;

                if (methodUId == method.methodUId){

                    addTabMethod(classUId,method);
                    break;
                }
            }
        }
    }


    function addTabMethod(classUId,method){
        let methodDescription = method.description;
        let methodUId = method.methodUId;

        let tabs = $(".right-nav li");
        let flag = false;
        if (tabs){
            for (let i = 0; i < tabs.length; i++) {
                let $methodUId = $( tabs[i]).find("a").attr("data-method-uid");

                if ($methodUId && $methodUId == methodUId){
                    $(tabs[i]).addClass("active");
                    rightContentItemChange(methodUId);
                    flag = true;
                }else{
                    $(tabs[i]).removeClass("active");
                }
            }
        }
        if (!flag){
            let h = "<li class='active'><a data-class-uid='"+classUId+"' data-method-uid='"+methodUId+"' href=\"#tab2\" >"+methodDescription+"</a> <span class=\"close\"></span></li>";
            $(".right-nav").append(h);

            addRightContent(classUId,method);
        }
        initTabs();
    }

    function addRightContent(classUId,method){
        let methodId = method.methodId;
        let methodUId = method.methodUId;
        let methodDescription = method.description;
        let path = method.path;
        let methodType = method.method;




        let requestList = JSON.parse(storage.get("requestList"));
        let responseList = JSON.parse(storage.get("responseList"));
        let request=null;
        let response=null;
        for (let i = 0; i < requestList.length; i++) {
            let r = requestList[i];
            if (r.methodId == methodId){
               request = r;
            }
        }
        for (let j = 0; j < responseList.length; j++) {
            let r = responseList[j];
            if (r.methodId == methodId){
                response = r;
            }
        }

        $("#rightContent .right-content-item").removeClass("active");

        let debugTemplateData=new Object();
        debugTemplateData.method = method;
        debugTemplateData.request = request;
        debugTemplateData.response = response;

        let html="";
        let requestBodyHtml = "";
        if (request){
            requestBodyHtml = getRequestHtml(request);
        }
        debugTemplateData.requestBodyHtml = requestBodyHtml;


        let responseBodyHtml = "";
        if (response){
            responseBodyHtml = getResponseHtml(response);
        }
        debugTemplateData.responseBodyHtml= responseBodyHtml;

        console.log(debugTemplateData);

        let data={
            method: method,
            request: request,
            response: response
        }


        let docHtml = template("docTemplateId",data);
        // let debugHtml = template("debugTemplate",debugTemplateData);
        html+=docHtml;
        // html+=debugHtml;

        // document.getElementById("rightContent")

        $("#rightContent").append(html);

        $("#"+methodUId+"requestBodyHtml").html(requestBodyHtml);
        $("#"+methodUId+"responseBodyHtml").html(responseBodyHtml);

        initRequestContentType(methodUId);

        initRequest(methodUId,request);

        initResponseHtml(methodUId);

    }


    function initRequestContentType(methodUId){
        $('input[type=radio][name='+methodUId+'contentType]').change(function() {
            let value=$(this).val();
            let methodUId = $(this).attr("name").replaceAll("contentType","");
            if (value==3){
                $("#"+methodUId+"Raw").show();
            }else{
                $("#"+methodUId+"Raw").hide();
            }
        });
    }



    function initResponseHtml(methodUId){
        $(".right-response-nav li").on("click",function (){
            $(".right-response-nav li").removeClass("active");
            $(this).addClass("active");
        });

        var editor = ace.edit(methodUId+"ace_editor");

        //设置风格和语言（更多风格和语言，请到github上相应目录查看）
        var theme = "xcode"
        var language = "json"
        editor.setTheme("ace/theme/" + theme);
        editor.session.setMode("ace/mode/" + language);
        //字体大小
        editor.setFontSize(12);
        //设置只读（true时只读，用于展示代码）
        editor.setReadOnly(false);
        //自动换行,设置为off关闭
        editor.setOption("wrap", "free")
        editor.session.setUseSoftTabs(true);
        //启用提示菜单
        ace.require("ace/ext/language_tools");
        editor.setOptions({
            enableBasicAutocompletion: true,
            enableSnippets: true,
            enableLiveAutocompletion: true
        });
        editor.resize()

        initRequestCheckBox(methodUId);
    }

    function initRequestCheckBox(methodUId){
        $("#"+methodUId+"AllId").click(function(){
            $("input[type='checkbox'][name='"+methodUId+"ChildRequest']").each(function(){ //反选
                if($(this).prop("checked")){
                    $(this).prop("checked",false);
                } else{
                    $(this).prop("checked",true);
                }
            });
        });
    }

    function initRequest(methodUId,request){
        if (request){
            var list = request.list;
            var headerHtml="";
            var queryHtml="";
            var bodyHtml="";
            if (list){
                $.each(list,function (index,r){
                    if (common.equalsIgnoreCase(r.requestType,"header")){
                        headerHtml+=initRequestQuery(r,methodUId);
                    }else if (common.equalsIgnoreCase(r.requestType,"body")){
                        bodyHtml+=initRequestBody(r,methodUId);
                    }else if (common.equalsIgnoreCase(r.requestType,"query")){
                        queryHtml+=initRequestQuery(r,methodUId);
                    }
                });
            }
            // console.log(headerHtml+queryHtml+bodyHtml)
            $("#"+methodUId+"RequestId").html(headerHtml+queryHtml+bodyHtml);
        }
    }



    function initRequestQuery(request,methodUId){
        var html="";
        if (request){
            html+="<tr>";
            html+="<td style='line-height: 30px;'><input type='checkbox' checked='checked' name='"+methodUId+"ChildRequest'  /></td>"
            html+="<td style='line-height: 30px;'>"+request.requestType+"</td>"
            html+="<td class='input-group-sm'><input type='text' class='form-control' value='"+request.name+"' /></td>"
            html+="<td class='input-group-sm'><input type='text' class='form-control' placeholder='"+request.description+"' /></td>"
            html+="</tr>";
        }
        return html;
    }
    function initRequestBody(request,methodUId){
        var html="";
        if (request){
            html+="<tr>";
            html+="<td><input type='checkbox' name='"+methodUId+"ChildRequest'  /></td>"
            html+="<td>"+request.requestType+"</td>"
            html+="<td>"+request.name+"</td>"
            html+="<td>";
            debugger

            let json={};
            var child = request.child;
            if (child){
                for (let i = 0; i < child.length; i++) {
                    let item=child[i];
                    initRequestBodyChild(item,json)
                }
            }
            let jsonText = JSON.stringify(json, null, '\t');
            let len = jsonText.split('\n').length
            html+="<textarea class='form-control' rows='"+len+"' >"+jsonText+"</textarea>";
            html+="</td>";
            html+="</tr>";
        }
        return html;
    }
    function initRequestBodyChild(request,json){
        if (request){

            if (common.like(request.dataType,"String")){
                json[""+request.name+":"]="";
            }else{

                let child = request.child;
                let collection = request.collection;

                if (collection==1 && child){
                    let array = [];
                    let childJson = {}
                    $.each(child,function (index,r){
                        initRequestBodyChild(r,childJson);
                    });
                    array.push(childJson);
                    json[""+request.name+":"]=array;
                }else if (collection==0 && child){

                    let childJson = {}
                    $.each(child,function (index,r){
                        initRequestBodyChild(r,childJson);
                    });
                    json[""+request.name+":"]=childJson;
                }else{
                    json[""+request.name+":"]=0;
                }

            }
        }
    }

    function getRequestHtml(request){
        let h1="";
        if (request){
            let list = request.list;
            if (list){
                for (let ii = 0; ii < list.length; ii++) {
                    var r = list[ii];
                    h1+="<tr>"
                    h1+="<td>"+r.name+"</td>"
                    h1+="<td>"+r.description+"</td>"
                    h1+="<td>"+r.requestType+"</td>"
                    h1+="<td>"+r.required+"</td>"
                    h1+="<td>"+r.dataType+"</td>"
                    h1+="<td>"+common.formatValue(r.example)+"</td>"
                    h1+="</tr>"
                    h1+=getRequestChild(r);
                }
            }
        }
        return h1;
    }

    function getResponseHtml(response){
        let h2="";
        if (response){
            let list = response.list;
            if (list){
                for (let jj = 0; jj < list.length; jj++) {
                    var r = list[jj];
                    h2+="<tr>"
                    h2+="<td>"+r.name+"</td>"
                    h2+="<td>"+r.description+"</td>"
                    h2+="<td>"+r.dataType+"</td>"
                    h2+="</tr>"
                    h2+=getResponseChild(r);
                }
            }
        }
        return h2;
    }

    function getResponseChild(p,separator){
        if (p){
            let child = p.child;
            if (child){
                if (!separator){
                    separator = "&nbsp;&nbsp;&nbsp;&nbsp;"
                }else{
                    separator=separator+separator;
                }

                let h3="";
                for (let k = 0; k < child.length; k++) {
                    var r = child[k];
                    h3+=("<tr>");
                    h3+=("<td>"+separator+r.name+"</td>");
                    h3+=("<td>"+r.description+"</td>");
                    h3+=("<td>"+r.dataType+"</td>");
                    h3+=("</tr>");
                    h3+=(getResponseChild(r,separator));
                }
                return h3;
            }
        }
        return "";
    }

    function getRequestChild(p,separator){
        if (p){
            let child = p.child;
            if (child){
                if (!separator){
                    separator = "&nbsp;&nbsp;&nbsp;&nbsp;"
                }else{
                    separator=separator+separator;
                }

                let h3="";
                for (let k = 0; k < child.length; k++) {
                    var r = child[k];
                    h3+=("<tr>");
                    h3+=("<td>"+separator+r.name+"</td>");
                    h3+=("<td>"+r.description+"</td>");
                    h3+=("<td>"+r.requestType+"</td>");
                    h3+=("<td>"+r.required+"</td>");
                    h3+=("<td>"+r.dataType+"</td>");
                    h3+="<td>"+common.formatValue(r.example)+"</td>"
                    h3+=("</tr>");
                    h3+=(getRequestChild(r,separator));
                }
                return h3;
            }
        }
        return "";
    }

    function rightContentItemChange(methodUId){
        $("#rightContent .right-content-item").removeClass("active");
        var items = $("#rightContent .right-content-item");
        if (items){
            for (let i = 0; i < items.length; i++) {
                var uid = $(items[i]).attr("id");
                if (uid== methodUId){
                    $(items[i]).addClass("active");
                }
            }
        }
    }


    function init(){
        util.post("./mars/api",{},false,true,function (data){
            if (data){

                let classList = data.classList;

                storage.set("classList",JSON.stringify(classList));
                storage.set("requestList",JSON.stringify(data.requestList));
                storage.set("responseList",JSON.stringify(data.responseList));

                initLeft(classList,null);
            }
        });
    }

    function initLeft(classList,searchInput){
        let menuHtml="";
        if (classList){
            for (let i = 0; i < classList.length; i++) {
                let classInfo =classList[i];
                let classUId = classInfo.classUId;
                let methodList = classInfo.methodList;
                let methodHtml = "";
                if (methodList){
                    methodHtml = initLeftMethod(classUId,methodList,searchInput);
                }
                if (common.isEmpty(methodHtml)) {
                    continue;
                }

                menuHtml+="<li class=\"detailMenu\">"
                menuHtml+="<a class=\"ma1\">"+classInfo.description+"</a>";


                menuHtml+="<ul class=\"submenu\">";

                menuHtml+=methodHtml;

                menuHtml+="</ul>"
                menuHtml+="</li>"
            }
        }
        $("#menu").html(menuHtml);
        initLeftMenu();
    }

    function initLeftMethod(classUId,methodList,searchInput){
        let menuHtml="";
        if (!methodList){
            return menuHtml;
        }
        for (let j = 0; j < methodList.length; j++) {
            let methodInfo = methodList[j];

            let methodType = methodInfo.method;
            let methodUId = methodInfo.methodUId;
            let methodId = methodInfo.methodId;
            let description = methodInfo.description;

            if (common.isNotEmpty(searchInput) ){
                if (!common.like(description,searchInput)){
                    continue;
                }
            }
            menuHtml+="<li class=\"menuLi\">" +
                "<a class=\"ma2\" data-class-uid='"+classUId+"'  data-method-uid='"+methodUId+"' data-method-id='"+methodId+"' >"+methodType+"&nbsp;&nbsp;"+description+"</a>" +
                "</li>" ;
        }
        return menuHtml;
    }

    function changeFrameHeight(){
        var iframe=document.getElementById("rightContent");
        iframe.height = document.documentElement.clientHeight;
    }
    window.onresize=function(){
        changeFrameHeight();
    }





</script>
</html>
