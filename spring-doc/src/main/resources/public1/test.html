<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Mars Doc</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <link href="./css/layui.css" rel="stylesheet"/>
    <link href="./css/iconfont.css" rel="stylesheet"/>

    <script type="text/javascript" src="./jquery.min.js"></script>
    <script type="text/javascript" src="./ace/ace.js"></script>
    <script type="text/javascript" src="./ace/ext-language_tools.js"></script>
    <script type="text/javascript" src="./json5.js"></script>
    <style>

        .layui-header-search {
            width: 300px;
            line-height: 60px;
            text-align: center;
            font-size: 16px;
            top: 11px;
            padding-right: 10px;
        }

        .nav-right-top>.layui-tab-title>.layui-this {
            background-color: #009688 !important;
            color: #fff !important;
        }

        .layui-tab-div {
            margin: 0px auto !important;
        }

        .layui-form-static {
            min-height: 36px;
            margin-left: 110px;
            line-height: 36px;
        }

        .layui-nav-tree a {
            font-size: 10px;
        }

        .layui-nav-tree span {
            font-size: 10px;
        }

        .left-method {
            width: 32px;
            text-align: center;
            line-height: 40px;
        }
        .padding-left-20{
            padding-left: 20px;
        }
        .padding-right-15{
            padding-right: 15px;
        }

        .padding-left-level-2{
            padding-left: 30px;
        }
        .padding-left-level-3{
            padding-left: 60px;
        }
        .padding-left-level-4{
            padding-left: 90px;
        }
        .padding-left-level-5{
            padding-left: 120px;
        }
        .padding-left-level-6{
            padding-left: 150px;
        }
        .padding-left-level-7{
            padding-left: 180px;
        }
        .padding-left-level-8{
            padding-left: 210px;
        }
        .request-table-div{
            margin: 0 auto;
            /*padding-left: 36px;*/
        }
        .layui-form-label {
            position: relative;
            float: left;
            display: block;
            padding: 9px 0px;
            font-weight: 400;
            line-height: 20px;
            text-align: left;
        }
        .layui-table-cell {
            height:auto !important;
        }

        .debug-span-value {
            color: #4dc095;
            font-size: 12px;
            font-weight: bold;
        }
        .debug-span-value-error {
            color: red;
            font-size: 12px;
            font-weight: bold;
        }

        .debug-request-table input[type=checkbox]{
            width: 15px;height: 15px;
        }
    </style>
</head>
<body>


<div class="layui-layout layui-layout-admin">

    <!-- header start -->
    <div class="layui-header layui-bg-green">
        <div class="layui-logo layui-hide-xs layui-bg-black">
            <select class="layui-select" id="groupName" style="width: 85%;height: 25px;">
                <option value="default">default</option>
            </select>
        </div>
        <!-- 头部区域（可配合layui 已有的水平导航） -->
        <div class="layui-header-search layui-layout-right">
            <input type="text" id="search" placeholder="请输入搜索內容" autocomplete="off" class="layui-input">
        </div>
    </div>
    <!-- header end -->

    <!-- left start -->
    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">

            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree" id="leftDivId" lay-shrink="all" lay-filter="navLeft" lay-allowClose="true">

            </ul>
        </div>
    </div>
    <!-- left start -->

    <div class="layui-body">
        <div class="layui-tab layui-tab-div nav-right-top" lay-filter="rightTab" lay-allowClose="true">
            <ul class="layui-tab-title">

            </ul>
            <div class="layui-tab-content" style="padding: 15px 40px 15px 40px;">

            </div>
        </div>

        <div style="padding: 15px;">
            <div class="layui-card layui-panel">

            </div>
        </div>

    </div>

</div>

<div style="display: none;" id="leftTemplate">
    {{each classList as classInfo classIndex}}
    <li class="layui-nav-item">
        <a class="" href="javascript:;">{{classInfo.description}}</a>
        {{if classInfo.methodList!=null }}
        <dl class="layui-nav-child layui-nav-child-r">
            {{each classInfo.methodList as method methodIndex }}
            <dd style="display: flex;">
                <span class="left-method">{{method.method}}</span>
                <a href="javascript:;"
                   class-uid="{{classInfo.classUId}}"
                   method-id="{{method.methodId}}"
                   method-name="{{method.description}}"
                   method-method="{{method.method}}"
                >
                    {{method.description}}
                </a>
            </dd>
            {{/each}}
        </dl>
        {{/if}}
    </li>
    {{/each}}
</div>

<script type="text/html" id="rightContentTemplate">

    <div>
        <label class="layui-form-label">接口描述:</label>
        <div class="layui-form-static">
            {{method.description}}
        </div>
    </div>
    <hr>
    <div>
        <label class="layui-form-label">接口地址:</label>
        <div class="layui-form-static">
            {{method.path}}
        </div>
    </div>
    <hr>
    <div>
        <label class="layui-form-label">请求方式:</label>
        <div class="layui-form-static">
            {{method.method}}
        </div>
    </div>
    <hr>
    <div>
        <label class="layui-form-label">请求参数:</label>
        <div class="layui-form-static"></div>
    </div>
    <div class="request-table-div">
        <table lay-filter="{{method.methodUId}}requestTable" class="layui-table">
            <thead>
            <tr>
                <th lay-data="{field:'name', width:'26%',templet:'#nameTemplet'}">参数名称</th>
                <th lay-data="{field:'description',  width:'26%'}">参数说明</th>
                <th lay-data="{field:'requestType', width:'8%'}">请求类型</th>
                <th lay-data="{field:'required', width:'8%'}">是否必须</th>
                <th lay-data="{field:'dataType', width:'22%'}">数据类型</th>
                <th lay-data="{field:'example', width:'10%'}">示例值</th>
                <th lay-data="{field:'child',hide:'true'}"></th>
                <th lay-data="{field:'collection',hide:'true'}"></th>
                <th lay-data="{field:'level',hide:'true'}"></th>
            </tr>
            </thead>
            <tbody>
            {{if formatRequest!=null && formatRequest.length>0}}
                {{each formatRequest rl requestListIndex}}
                    <tr>
                        <td>{{rl.name}}</td>
                        <td>{{rl.description}}</td>
                        <td>{{rl.requestType|toLowerCase}}</td>
                        <td>{{rl.required}}</td>
                        <td>{{rl.dataType}}</td>
                        <td>{{rl.example!=null?rl.example:''}}</td>
                        <td>{{rl.child}}</td>
                        <td>{{rl.collection}}</td>
                        <td>{{rl.level}}</td>
                    </tr>
                {{/each}}
            {{/if}}
            </tbody>
        </table>
    </div>
    <hr>

    <div>
        <label class="layui-form-label">响应参数:</label>
        <div class="layui-form-static"></div>
    </div>
    <div class="request-table-div">
        <table lay-filter="{{method.methodUId}}responseTable" class="layui-table">
            <thead>
            <tr>
                <th lay-data="{field:'name', width:'33%',templet:'#nameTemplet'}">参数名称</th>
                <th lay-data="{field:'description',  width:'34%'}">参数说明</th>
                <th lay-data="{field:'dataType', width:'33%'}">数据类型</th>
                <th lay-data="{field:'child',hide:'true'}"></th>
                <th lay-data="{field:'collection',hide:'true'}"></th>
                <th lay-data="{field:'level',hide:'true'}"></th>
            </tr>
            </thead>
            <tbody>
                {{if formatResponse!=null && formatResponse.length>0}}
                {{each formatResponse rl requestListIndex}}
                <tr>
                    <td>{{rl.name}}</td>
                    <td>{{rl.description}}</td>
                    <td>{{rl.dataType}}</td>
                    <td>{{rl.child}}</td>
                    <td>{{rl.collection}}</td>
                    <td>{{rl.level}}</td>
                </tr>
                {{/each}}
                {{/if}}
            </tbody>
        </table>
    </div>
    <hr>
    <div>
        <label class="layui-form-label">响应示例:</label>
        <div class="layui-form-static"></div>
    </div>

    <div class="request-table-div">
        <div class="" id="{{ method.methodUId }}ace_editor" style="height: 100px;    overflow: visible!important;" >
        </div>
    </div>
    <hr>



    <form class="layui-form" action="">

        <div style="display: inline-flex;width: 100%;padding: 9px 0px;" >
            <button class="layui-btn"   >{{method.method}}</button>
            <input type="text" name="title"  autocomplete="off" id="methodPath{{method.methodUId}}" class="layui-input" value="{{method.path}}" />
            <button class="layui-btn" lay-active="sendRequest" method-uid="{{method.methodUId}}" request-method="{{method.method}}"  type="button"> 发 送 </button>
        </div>


        <div style="display: inline-flex;width: 100%;padding: 9px 0px;" >

            <input type="radio" name="{{method.methodUId}}contentType" method-uid="{{method.methodUId}}"   value="x-www-form-urlencoded" title="x-www-form-urlencoded">
            <input type="radio" name="{{method.methodUId}}contentType" method-uid="{{method.methodUId}}"  value="form-data" title="form-data" >
            <input type="radio" name="{{method.methodUId}}contentType" method-uid="{{method.methodUId}}" value="raw" title="raw" >


            <select class="form-select form-select-sm " lay-ignore id="raw{{method.methodUId}}" style="display:none;" >
                <option value="application/json" selected>JSON(application/json)</option>
                <option value="text">Text</option>
                <option value="text/plain">Text(text/plain)</option>
                <option value="application/xml">XML(application/xml)</option>
                <option value="text/xml">XML(text/xml)</option>
                <option value="text/html">HTML(text/html)</option>
                <option value="application/javascript">Javascript(application/javascript)</option>
            </select>
        </div>



        <div style="display: inline-flex;width: 100%;padding: 9px 0px;" >
            <table  class="layui-table debug-request-table" lay-size="lg">
                <thead>
                    <tr>
                        <th style="width: 4%;" ><input type="checkbox" request-checkbox-all="change" checked="checked" lay-ignore name="debugRequestCheckbox{{method.methodUId}}"  /></th>
                        <th style="width: 10%;" >参数类型</th>
                        <th style="width: 17%;" >参数名</th>
                        <th style="width: 66%;" >参数值</th>
                    </tr>
                </thead>
                <tbody id="debugRequestTableId{{method.methodUId}}" >
                {{if debugRequest!=null && debugRequest.length>0}}
                {{each debugRequest rl requestListIndex}}

                    <tr>
                        <td><input type="checkbox"  checked="checked"  lay-ignore name="debugRequestCheckbox{{method.methodUId}}"  /></td>
                        <td  >{{rl.requestType|toLowerCase}}</td>
                        <td><input type="text" class="layui-input" value="{{rl.name}}" /></td>
                        {{if rl.requestType=='BODY'}}
                            <td><textarea class="layui-textarea" rows="{{rl.jsonLine}}" placeholder="{{rl.description}}" >{{rl.jsonText}}</textarea></td>
                        {{else}}
                            <td><input type="text" class="layui-input" value="" placeholder="{{rl.description}}" /></td>
                        {{/if}}
                    </tr>

                {{/each}}
                {{/if}}
                </tbody>
            </table>

        </div>


        <div style="display: inline-flex;width: 100%;padding: 9px 0px;" >
            <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief" style="width: 100%;margin-bottom: 100px;">
                <ul class="layui-tab-title">
                    <li class="layui-this">响应内容</li>
                    <li>Raw</li>
                    <li>Header</li>
                    <li>Curl</li>
                </ul>
                <div style="right: 40px;position: absolute;margin-top: -31px;z-index: 9999;" id="responseStatus{{method.methodUId}}">
                    <!--<span class="debug-span-label" style="margin-right:30px;font-weight: bold;">
                        <div class="checkbox" style="display: inline;">
                            <label><input id="checkboxShowDescriptionb144f10b3b5a388b4180dfbf33aa7f80" type="checkbox" checked="checked">显示说明</label>
                        </div>
                    </span>-->
                    <span class="debug-span-label">响应码:</span>
                    <span class="debug-span-value"></span>
                    <span class="debug-span-label">耗时:</span>
                    <span class="debug-span-value"></span>ms
                    <span class="debug-span-label">大小:</span>
                    <span class="debug-span-value"></span>
                </div>
                <div class="layui-tab-content" style="width: 100%;">
                    <div class="layui-tab-item layui-show">
                        <div id="debugResponseContent{{method.methodUId}}">

                        </div>
                    </div>
                    <div class="layui-tab-item">
                    <textarea class="layui-textarea" rows="10" id="debugResponseRawContent{{method.methodUId}}">

                    </textarea>
                    </div>
                    <div class="layui-tab-item">
                        <table class="layui-table debug-request-table"  >
                            <thead>
                            <tr>
                                <th>请求头</th>
                                <th>value</th>
                            </tr>
                            </thead>
                            <tbody id="responseHeader{{method.methodUId}}">
                            <tr>
                                <th class="active">connection</th>
                                <td> keep-alive</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="layui-tab-item">
                        <code>

                        </code>
                    </div>
                </div>
            </div>
        </div>


    </form>





</script>

<script type="text/html" id="nameTemplet">
    {{# if( d.child!='' &&  d.child!=null  && d.child!='[]' ){ }}
        {{# if(d.level>1){ }}
        <i class="padding-left-level-{{d.level}}"></i>
        {{# } }}
        <i class="layui-icon layui-icon-down"></i>
        <i class="iconfont icon-leimu "></i>
        {{d.name}}
    {{#  } else { }}
        {{# if(d.level>1){ }}
        <i class="padding-left-level-{{d.level}}"></i>
        {{# } }}
         <i class="padding-left-20"></i>
        <i class="icon iconfont icon-shuxing"></i>
        {{d.name}}
    {{#  } }}
</script>
<script type="text/html" id="debugRequestName">
    <input type="text" class="layui-input" value="{{d.name}}" />
</script>
<script type="text/html" id="debugRequestValue">
    {{# if( d.requestType=='BODY' || d.requestType=='body' ){ }}
        <textarea class="layui-textarea" rows="{{d.jsonLine}}" >{{d.jsonText}}</textarea>
    {{#  } else { }}
        <input type="text" class="layui-input" value="" placeholder="{{d.description}}" />
    {{#  } }}
</script>

<script type="text/html" id="responseHeaderTemplate">
    {{each list h index}}
        <tr>
            <th class="active">{{h.key}}</th>
            <td>{{h.value}}</td>
        </tr>
    {{/each}}
</script>
<script type="text/html" id="responseStatusTemplate">
    {{if responseStatus==200}}
        <span class="debug-span-label">响应码:</span>
        <span class="debug-span-value">{{responseStatus}} ok</span>
        <span class="debug-span-label">耗时:</span>
        <span class="debug-span-value">{{responseTime}}ms</span>
        <span class="debug-span-label">大小:</span>
        <span class="debug-span-value">{{responseSpace}}</span>
    {{else}}
        <span class="debug-span-label">响应码:</span>
        <span class="debug-span-value-error">{{responseStatus}}</span>
        <span class="debug-span-label">耗时:</span>
        <span class="debug-span-value-error">{{responseTime}}ms</span>
        <span class="debug-span-label">大小:</span>
        <span class="debug-span-value-error">{{responseSpace}}</span>
    {{/if}}

</script>


<script type="text/javascript" src="./layui.js"></script>
<!--    <script type="text/javascript" src="./mars-doc.js"></script>-->
<script type="text/javascript" src="./template-web.js"></script>
<script type="text/javascript">

    template.defaults.imports.toLowerCase=function (s){
        if(s){
            return s.toLowerCase();
        }
        return "";
    }


    // 本地缓存处理
    let storage = {
        set: function (key, value) {
            window.localStorage.setItem(key, JSON.stringify(value));
        },
        get: function (key) {
            let value = window.localStorage.getItem(key);
            if (value) {
                return strToJson(value);
            }
            return null;
        },
        remove: function (key) {
            window.localStorage.removeItem(key);
        },
        clear: function () {
            window.localStorage.clear();
        }
    };

    function strToJson(str) {
        var json = eval('' + str + '');
        return json;
    }

    String.prototype.equalsIgnoreCase = function(anotherString) {
        if(this === anotherString){
            return true;
        }
        if(typeof(anotherString)==='string'){
            return this.toLowerCase() == anotherString.toLowerCase(); //
        }
        return false;
    };



    layui.use(['element', 'jquery', 'layer', 'util', 'table','form','util'], function () {
        var element = layui.element , layer = layui.layer, util = layui.util, table = layui.table, $ = layui.$,form = layui.form;

        let responseEditorMap =new Map();

        element.on('tab(rightTab)', function (data) {
            console.log("test1:" + this, data);
        });


        form.on('radio', function(data){

            let thisVal = data.value;
            let methodUId = $(this).attr("method-uid");
            console.log(data,thisVal,$("#"+methodUId+"RawDiv"));
            if (thisVal=='raw'){
                document.getElementById("raw"+methodUId).style.display='';
            }else{
                document.getElementById("raw"+methodUId).style.display='none'
            }
        });

        util.event('lay-active',{
            sendRequest:function (){

                let $this = $(this);

                let methodUId = $(this).attr("method-uid");
                console.log(methodUId);

                let requestMethod = $(this).attr("request-method");
                let requestPath = $(this).parent().find("[id='methodPath"+methodUId+"']").val()

                let debugRequestTableBody = $(this).parent().parent().find("[id='debugRequestTableId"+methodUId+"']");

                let requestContentType = $('input[name="'+methodUId+'contentType"]:checked').val();
                let isStream = false;
                if ("raw".equalsIgnoreCase(requestContentType)){
                    isStream = true;
                    requestContentType =$(this).parent().parent().find("[id='raw"+methodUId+"']").val();
                }
                console.log("requestContentType:"+requestContentType)
                let headerData= {};
                let bodyData = {};
                let formData = {};

                let trs = debugRequestTableBody.find("tr");
                if (trs){
                    for (let i = 0; i < trs.length; i++) {
                        let tr = trs[i];
                        let checkbox = $(tr).find("input[type='checkbox']").is(':checked');
                        if (checkbox){
                            let tds = $(tr).children('td');
                            let requestType = $(tds[1]).text();
                            if ("query".equalsIgnoreCase(requestType)){
                                let queryName = $(tds[2]).find("input").val();
                                let queryValue= $(tds[3]).find("input").val();
                                formData[queryName]=queryValue;
                            }else if ("body".equalsIgnoreCase(requestType)){

                                let queryName = $(tds[2]).find("input").val();
                                let queryValue= $(tds[3]).find("textarea").val();
                                try {
                                    JSON5.parse(queryValue);
                                }catch (e){
                                    console.error("parseJson error");
                                    layer.msg('parse json:'+ queryValue+",失败", {icon: 2});
                                    return false;
                                }
                                bodyData = Object.assign(bodyData,JSON5.parse(queryValue));

                            }else if ("header".equalsIgnoreCase(requestType)){
                                let queryName = $(tds[2]).find("input").val();
                                let queryValue= $(tds[3]).find("input").val();
                                headerData[queryName]=queryValue;
                            }
                            console.log(requestType);
                        }

                    }
                }

                console.log("formData:"+JSON.stringify(formData),"bodyData:"+JSON.stringify(bodyData)+"headerData:"+JSON.stringify(headerData));

                let startDate  = (new Date()).getTime();
                sendRequest("./" + requestPath,
                    requestMethod,
                    Object.assign(formData, bodyData),
                    headerData,
                    "json",
                    isStream,
                    function (response, status, xhr) {

                        console.log("success")
                        console.log(response);	//服务器返回的信息
                        console.log(status);	//服务器返回的信息
                        console.log(xhr)
                        console.log(xhr.status);	//状态码,   要看其他的直接 输出 xhr 就行
                        console.log(xhr.getAllResponseHeaders()); //响应头部
                        console.log("response:" + response, "status:" + status, "xhr:" + xhr)

                        writerResponseContent($this,methodUId,xhr);
                        writeResponseHeader($this,methodUId,xhr);
                        writeResponseStatus($this,methodUId,xhr,startDate);

                    }
                    , function (xhr, status, error) {
                        console.error("error")
                        console.log(xhr,status,error);
                        writerResponseContent($this,methodUId,xhr);
                        writeResponseHeader($this,methodUId,xhr);

                        writeResponseStatus($this,methodUId,xhr,startDate)
                    })

            }
        })

        function writerResponseContent($this,methodUId,xhr){
            let responseText = xhr.responseText;
            if (responseText){
                var contentType=xhr.getResponseHeader("Content-Type");
                var contentDisposition=xhr.getResponseHeader("Content-Disposition");
                console.log("response contentType",contentType+" contentDisposition:"+contentDisposition);
                let mode = "json"
                let jsonText =responseText;
                if (jsonText){

                    try {
                        jsonText = JSON5.stringify(JSON5.parse(jsonText),null,"\t");
                    }catch (e){
                        console.log(e);
                        mode="text";
                    }
                    let jsonLine = jsonText.split('\n').length;



                    let responseEditor = responseEditorMap.get(methodUId);
                    responseEditor.setTheme("ace/theme/xcode");
                    responseEditor.session.setMode("ace/mode/"+mode);
                    responseEditor.setOption("maxLines", jsonLine + 10);
                    responseEditor.setOption("minLines", jsonLine)
                    responseEditor.setValue(jsonText);
                    responseEditor.setReadOnly(true);
                    responseEditor.clearSelection();
                    responseEditor.resize();

                    $this.parent().parent().find("[id='debugResponseRawContent"+methodUId+"']").html(jsonText);
                }else{
                    let responseEditor = responseEditorMap.get(methodUId);
                    responseEditor.setValue('');
                    responseEditor.resize();
                    $this.parent().parent().find("[id='debugResponseRawContent"+methodUId+"']").html('');
                }

            }else{
                let responseEditor = responseEditorMap.get(methodUId);
                responseEditor.setValue('');
                responseEditor.resize();
                $this.parent().parent().find("[id='debugResponseRawContent"+methodUId+"']").html('');
            }
        }



        function writeResponseHeader($this,methodUId,xhr){
            let responseHeaders = xhr.getAllResponseHeaders();
            if (responseHeaders) {
                let hss = responseHeaders.split("\r\n");
                let hsList = new Array();
                for (let i = 0; i < hss.length; i++) {
                    let hs = hss[i];
                    if (hs) {
                        let key = hs.substring(0, hs.indexOf(":"));
                        let value = hs.substring(hs.indexOf(":"), hs.length);
                        hsList.push({key: key, value: value})
                    }
                }
                let hsHtml = template("responseHeaderTemplate", {list: hsList})
                $this.parent().parent().find("[id='responseHeader"+methodUId+"']").html(hsHtml);
            }
        }

        function writeResponseStatus($this,methodUId,xhr,startDate){
            let responseStatus = xhr.status;
            let endDate = (new Date()).getTime();
            let responseTime = endDate-startDate;
            let responseText = xhr.responseText;
            let responseSpace = "0 b";
            if (responseText){
                responseSpace = getTextSpace(responseText);
            }
            let html = template("responseStatusTemplate",{responseStatus:responseStatus,responseTime:responseTime,responseSpace:responseSpace})
            $this.parent().parent().find("[id='responseStatus"+methodUId+"']").html(html);
        }

        function getTextSpace(text){
            if (!text){
                text="";
            }
            let limit = unescape(encodeURIComponent(text)).length;

            let size = "";
            if(limit < 0.1 * 1024){                            //小于0.1KB，则转化成B
                size = limit.toFixed(2) + "B"
            }else if(limit < 0.1 * 1024 * 1024){            //小于0.1MB，则转化成KB
                size = (limit/1024).toFixed(2) + "KB"
            }else if(limit < 0.1 * 1024 * 1024 * 1024){        //小于0.1GB，则转化成MB
                size = (limit/(1024 * 1024)).toFixed(2) + "MB"
            }else{                                            //其他转化成GB
                size = (limit/(1024 * 1024 * 1024)).toFixed(2) + "GB"
            }
            let sizeStr = size + "";                        //转成字符串
            let index = sizeStr.indexOf(".");                    //获取小数点处的索引
            let dou = sizeStr.substr(index + 1 ,2)            //获取小数点后两位的值
            if(dou == "00"){                                //判断后两位是否为00，如果是则删除00
                return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
            }
            return size;
        }

        function sendRequest(url,method,data,headers,dataType,isStream,successCallback,errorCallback){
            let loading = null;
            let config = {
                url: url,
                type: method,
                dataType: dataType,
                data: data,
                async:true,
                headers:headers,
                beforeSend: function () {
                    loading = layer.load(0, {shade: [0.5,'#fff']});
                },
                success: function(response,status,xhr) {

                    layer.close(loading);
                    successCallback(response,status,xhr);
                },error:function (xhr, status, error) {
                    layer.close(loading);
                    errorCallback(xhr,status,error);
                }
            };
            if (isStream){
                let newConfig={
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }
                config = $.extend(config, newConfig);
            }
            $.ajax(config)
        }

        util.event('request-checkbox-all',{
           change:function (){
               let name = this.name;
               if (this.checked){
                   $("input[name='"+name+"']").prop("checked",true);
               }else{
                   $("input[name='"+name+"']").removeAttr("checked");
               }
           }
        });






        element.on("nav(navLeft)", function (data) {
            console.log(this)
            let methodId = $(this).attr("method-id");
            let methodMethod = $(this).attr("method-method");

            let methodUId = methodId+"#"+methodMethod;
            if (methodUId) {

                if (existTab(methodUId)) {
                    layui.element.tabChange('rightTab', methodUId)
                } else {

                    let classUId = $(this).attr("class-uid");
                    let title = $(this).attr("method-name");
                    if (!title){
                        return;
                    }

                    let thisMethod = getMethod(classUId, methodId,methodMethod);
                    if (thisMethod){
                        thisMethod.methodUId = methodUId;
                    }

                    let thisRequest = getRequest(methodId);
                    let thisResponse = getResponse(methodId);
                    if (thisMethod) {

                        let data = {
                            method: thisMethod,
                            request: thisRequest,
                            response: thisResponse,
                            formatRequest:formatParam(thisRequest),
                            formatResponse:formatParam(thisResponse),
                            debugRequest:getDebugFormatParam(thisRequest)
                        }
                        console.log("data:", data);
                        let rightContentHtml = template("rightContentTemplate", data);
                        // console.log("rightContentHtml:", rightContentHtml);
                        layui.element.tabAdd('rightTab', {title: title, content: rightContentHtml, id: methodUId})
                        layui.element.tabChange('rightTab', methodUId);

                        table.init(methodUId + 'requestTable', { //转化静态表格
                            // height: 'full-500'
                            size: 'sm',
                            text: {
                                none: '暂无参数'
                            },
                        });
                        table.init(methodUId + 'responseTable', { //转化静态表格
                            // height: 'full-500'
                            size: 'sm',
                            text: {
                                none: '暂无返回值'
                            },
                        });


                        form.render();

                        initResponseJson(thisResponse,methodUId);

                        initDebugResponseContent(thisResponse,methodUId,"debugResponseContent"+methodUId);

                        $("#debugRequestCheckboxAll"+methodUId).on("click",function (){
                            console.log($(this).attr("checked"));
                        })

                        $("#debugRequestCheckboxAllM75d6729a5b0a38616904da54fb92de4#GET").on("change",function(){
                            console.log($(this).attr("checked"));
                        });

                    }
                }
            }
        });

        function initResponseJson(thisResponse,methodUId){
            let responseJson = getResponseJson(thisResponse,methodUId);

            var editor = ace.edit(methodUId+"ace_editor");
            if (responseJson){
                editor.setValue(responseJson.jsonText);
            }else {
                editor.setValue("{\n\t}");
            }
            editor.setTheme("ace/theme/xcode");
            editor.session.setMode("ace/mode/json5");
            editor.setAutoScrollEditorIntoView(false);
            if (responseJson){
                editor.setOption("maxLines", responseJson.jsonLine);
            }else{
                editor.setOption("maxLines", 3);
            }
            editor.setReadOnly(true);
            editor.clearSelection();
            editor.resize();
        }
        var editor=null;
        function initDebugResponseContent(thisResponse,methodUId,debugResponseContentId){
            let responseJson = getResponseJson(thisResponse,methodUId);

            editor = ace.edit(debugResponseContentId);
            if (responseJson){
                editor.setValue(responseJson.jsonText);
            }else {
                editor.setValue("{\n\t}");
            }
            editor.setTheme("ace/theme/xcode");
            editor.session.setMode("ace/mode/json5");
            // editor.setAutoScrollEditorIntoView(false);
            if (responseJson){
                editor.setOption("maxLines", responseJson.jsonLine+10);
                editor.setOption("minLines",responseJson.jsonLine)
            }else{
                editor.setOption("maxLines", 13);
                editor.setOption("minLines",3)
            }
            var length_editor = editor.session.getLength();
            var rows_editor = length_editor * 16;
            console.log(rows_editor);
            $("#"+debugResponseContentId).css('height',rows_editor+"px");
            editor.setReadOnly(true);
            editor.clearSelection();
            editor.resize();
            responseEditorMap.set(methodUId,editor);
        }

        function getResponseJson(response){
            let json={};
            var child = response.list;
            if (child){
                for (let i = 0; i < child.length; i++) {
                    let item=child[i];
                    appendJson(item,json)
                }
            }

            let jsonText = JSON.stringify(json, null, '\t');
            let len = jsonText.split('\n').length;
            json.jsonText= jsonText;
            json.jsonLine = len;
            return json;
        }



        function appendJson(request,json){
            if (request){
                if (like(request.dataType,"String")){
                    json[""+request.name+":"]="";
                }else{

                    let child = request.child;
                    let collection = request.collection;

                    if (collection==1 && child){
                        let array = [];
                        let childJson = {}
                        $.each(child,function (index,r){
                            appendJson(r,childJson);
                        });
                        array.push(childJson);
                        json[""+request.name+":"]=array;
                    }else if (collection==0 && child){

                        let childJson = {}
                        $.each(child,function (index,r){
                            appendJson(r,childJson);
                        });
                        json[""+request.name+":"]=childJson;
                    }else{
                        json[""+request.name+":"]=0;
                    }
                }
            }
        }

        function getMethod(classUId, methodId,methodMethod) {
            let classList = storage.get("classList");
            if (classList) {
                let classInfo = {};
                for (let i = 0; i < classList.length; i++) {
                    let clazz = classList[i];
                    if (clazz.classUId == classUId) {
                        classInfo = clazz;
                        break;
                    }
                }
                let methodInfo = {};
                if (classInfo) {
                    let methodList = classInfo.methodList;
                    if (methodList){
                        for (let j = 0; j < methodList.length; j++) {
                            let method = methodList[j];
                            if (method.methodId == methodId && method.method== methodMethod) {
                                methodInfo = method;
                                break;
                            }
                        }
                    }
                }
                return methodInfo;
            }
            return null;
        }

        function getRequest(methodId) {
            let requestList = storage.get("requestList");
            let request = {};
            if (requestList) {
                for (let i = 0; i < requestList.length; i++) {
                    let r = requestList[i];
                    if (r.methodId == methodId) {
                        request = r;
                        break;
                    }
                }
            }
            return request;
        }

        function getResponse(methodId) {
            let responseList = storage.get("responseList");
            let response = {};
            if (responseList) {
                for (let j = 0; j < responseList.length; j++) {
                    let r = responseList[j];
                    if (r.methodId == methodId) {
                        response = r;
                        break;
                    }
                }
            }
            return response;
        }

        function existTab(methodUId) {
            let exist = false;
            $(".layui-tab-title").find("li").each(function () {
                let id = $(this).attr("lay-id");
                if (id == methodUId) {
                    exist = true;
                }
            });
            return exist;
        }


        $.getJSON("./mars/api",{},function (data){
            if (data){
                initJsonGroup(data);
            }
        });
        // initJSON(json);

        function initJsonGroup(jsonArray){
            if (jsonArray){
                let groupNameHtml = "";
                let firstJson = null;
                for (let i = 0; i < jsonArray.length; i++) {
                    let json = jsonArray[i];
                    if (json){
                        if (i==0){
                            groupNameHtml+="<option selected='selected' value='"+json.groupName+"'>"+json.groupName+"</option>"
                            firstJson = json;
                        }else{
                            groupNameHtml+="<option  value='"+json.groupName+"'>"+json.groupName+"</option>"
                        }
                    }
                }
                $("#groupName").html(groupNameHtml);
                initJSON(firstJson);
            }
        }

        function initJSON(json) {

            if (json) {
                // $("#groupName").val(json.groupName);
                if (json.classList) {
                    storage.set("classList", json.classList);
                }
                if (json.requestList) {
                    storage.set("requestList", json.requestList);
                }
                if (json.responseList) {
                    storage.set("responseList", json.responseList);
                }
                initLeft(null);
            }
        }


        $("#search").keypress(function (even) {
            if (even.which == 13) {
                let searchInput = $("#search").val();
                initLeft(searchInput);
            }
        });

        function like(str, keyWord) {
            var reg = new RegExp(keyWord);
            //如果字符串中不包含目标字符会返回-1
            if (str.match(reg)) {
                //匹配成功do something
                return true;
            }
            return false;
        }

        function initLeft(searchInput) {
            let classList = storage.get("classList");
            if (searchInput && classList) {
                let newClassList = new Array();
                for (let i = 0; i < classList.length; i++) {
                    let classInfo = classList[i];
                    let newMethodList = new Array();
                    if (classInfo.methodList) {
                        let methodList = classInfo.methodList;
                        for (let j = 0; j < methodList.length; j++) {
                            let methodInfo = methodList[j];
                            if (like(methodInfo.description, searchInput)) {
                                newMethodList.push(methodInfo);
                            }
                        }
                    }
                    if (newMethodList.length > 0) {
                        classInfo.methodList = newMethodList;
                        newClassList.push(classInfo);
                    }
                }
                classList = newClassList;
            }
            let data = {
                classList: classList
            }
            let leftHtml = template("leftTemplate", data);
            document.getElementById("leftDivId").innerHTML = leftHtml;
            parent.layui.element.render('nav');
        }


        function formatParam(request){
            let requestList = new Array();
            if (request){
                let list=request.list;
                if (list){
                    let level=1;
                    for (let i = 0; i < list.length; i++) {
                        let r = list[i];
                        r.level=level;
                        requestList.push(r);
                        getChild(requestList,level,r);
                    }
                }
            }
            return requestList;
        }

        function getChild(requestList,level,request){
            if (request.child && request.child.length>0){
                let newLevel=level+1;
                let list= request.child;
                for (let j = 0; j < list.length; j++) {
                    let r = list[j];
                    r.level=newLevel;
                    requestList.push(r);
                    getChild(requestList,newLevel,r);
                }
            }
        }

        function getDebugFormatParam(request){
            let requestList = new Array();
            if (request){
                let list=request.list;
                if (list){
                    let level=1;
                    for (let i = 0; i < list.length; i++) {
                        let r = list[i];
                        r.level=level;
                        if ( (r.requestType=='BODY' || r.requestType=='body') && r.child!=null && r.child.length>0){
                            let childJson = getDebugRequestJson(r);
                            if (childJson){
                                r.jsonText = childJson.jsonText;
                                r.jsonLine = childJson.jsonLine;
                            }
                        }
                        requestList.push(r);
                    }
                }
            }
            return requestList;
        }
        function getDebugRequestJson(response){
            let json={};
            var child = response.child;
            if (child){
                for (let i = 0; i < child.length; i++) {
                    let item=child[i];
                    appendJson(item,json)
                }
            }

            let jsonText = JSON.stringify(json, null, '\t');
            let len = jsonText.split('\n').length;
            json.jsonText= jsonText;
            json.jsonLine = len;
            return json;
        }

        function guid() {
            function S4() {
                return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
            }
            return (S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4());
        }

        function getCharset(){
            let charSet = "";
            if (isIe()){
                charSet = document.charset;
            }else if (isFireFox()){
                charSet = document.characterSet;
            }else{
                charSet = document.characterSet;
            }
            return charSet;

            //判断是否IE
            function isIe() {
                let i = navigator.userAgent.toLowerCase().indexOf("msie");
                return i >= 0;
            }
            //判断是否firefox
            function isFireFox() {
                let i = navigator.userAgent.toLowerCase().indexOf("firefox");
                return i >= 0;
            }
        }

        String.prototype.getByteLength = function() {
            let len = 0;
            for (let i=0; i<this.length; i++) {
                if (this.charCodeAt(i)>127 || this.charCodeAt(i)==94) {
                    len += 2;
                } else {
                    len ++;
                }
            }
            return len;
        }


    });


</script>
</body>
</html>